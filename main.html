<!DOCTYPE html>

<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7A7 - Main</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: 'Manrope', sans-serif; 
        background: #050f0a; 
        color: white; 
        overflow: hidden;
    }

    /* Login Screen */
    #loginScreen {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #050f0a 0%, #0a1e14 50%, #050f0a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    #loginScreen.hidden { display: none; }

    .login-card {
        background: rgba(255,255,255,0.08);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 50px 40px;
        border: 1px solid rgba(255,255,255,0.1);
        max-width: 450px;
        width: 90%;
        text-align: center;
    }

    .login-card h1 {
        font-size: 42px;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #07FAA3, #02DC64);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .form-input {
        width: 100%;
        padding: 15px 20px;
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        color: white;
        font-size: 16px;
        font-family: 'Manrope', sans-serif;
        outline: none;
        margin-bottom: 15px;
    }

    .form-input:focus {
        border-color: #07FAA3;
    }

    .login-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #07FAA3, #02DC64);
        border: none;
        border-radius: 12px;
        color: #050f0a;
        font-weight: 800;
        font-size: 18px;
        cursor: pointer;
        font-family: 'Manrope', sans-serif;
        margin-top: 10px;
    }

    .login-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-msg {
        color: #ff4444;
        background: rgba(255,68,68,0.1);
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
        font-size: 14px;
    }

    .error-msg.show { display: block; }

    /* Main App Layout */
    #mainApp {
        display: none;
        height: 100vh;
        grid-template-columns: 280px 1fr;
    }

    #mainApp.active { display: grid; }

    /* Sidebar */
    .sidebar {
        background: rgba(255,255,255,0.03);
        border-right: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
    }

    .user-profile {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #07FAA3;
    }

    .user-info {
        flex: 1;
    }

    .username {
        font-weight: 700;
        font-size: 16px;
    }

    .coin-display {
        font-size: 14px;
        color: #07FAA3;
    }

    .channels {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .channel {
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .channel:hover {
        background: rgba(7,250,163,0.1);
    }

    .channel.active {
        background: rgba(7,250,163,0.2);
        border-left: 3px solid #07FAA3;
    }

    .pomodoro-widget {
        padding: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.03);
    }

    .pomodoro-time {
        font-size: 32px;
        font-weight: 800;
        text-align: center;
        color: #07FAA3;
        margin-bottom: 10px;
    }

    .pomodoro-controls {
        display: flex;
        gap: 10px;
    }

    .pomodoro-btn {
        flex: 1;
        padding: 10px;
        background: rgba(7,250,163,0.2);
        border: 1px solid #07FAA3;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        font-weight: 700;
    }

    .online-count {
        text-align: center;
        font-size: 14px;
        margin-top: 10px;
        opacity: 0.7;
    }

    /* Main Content */
    .main-content {
        display: flex;
        flex-direction: column;
    }

    .content-header {
        padding: 20px 30px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.03);
    }

    .channel-name {
        font-size: 24px;
        font-weight: 800;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 30px;
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }

    .message-author {
        font-weight: 700;
        color: #07FAA3;
    }

    .message-time {
        font-size: 12px;
        opacity: 0.5;
    }

    .message-text {
        line-height: 1.6;
    }

    .delete-btn {
        padding: 4px 10px;
        background: rgba(255,68,68,0.2);
        border: 1px solid rgba(255,68,68,0.3);
        border-radius: 6px;
        color: #ff4444;
        cursor: pointer;
        font-size: 12px;
    }

    .input-container {
        padding: 20px 30px;
        border-top: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.03);
        display: flex;
        gap: 10px;
    }

    .message-input {
        flex: 1;
        padding: 15px 20px;
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        color: white;
        font-size: 16px;
        font-family: 'Manrope', sans-serif;
        outline: none;
    }

    .message-input:focus {
        border-color: #07FAA3;
    }

    .send-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg, #07FAA3, #02DC64);
        border: none;
        border-radius: 12px;
        color: #050f0a;
        font-weight: 800;
        cursor: pointer;
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        opacity: 0.5;
    }

    .logout-btn {
        width: 100%;
        padding: 12px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        color: white;
        cursor: pointer;
        margin-top: 10px;
    }

    /* Mobile */
    @media (max-width: 768px) {
        #mainApp {
            grid-template-columns: 1fr;
        }

        .sidebar {
            display: none;
        }

        .sidebar.mobile-visible {
            display: flex;
            position: fixed;
            inset: 0;
            z-index: 1000;
        }
    }
</style>
 

</head>
<body>

 
<!-- Login Screen -->
<div id="loginScreen">
    <div class="login-card">
        <h1>üéì L·ªõp 7A7</h1>
        <p style="opacity: 0.6; margin-bottom: 30px;">ƒêƒÉng nh·∫≠p v√†o h·ªá th·ªëng</p>
        
        <input 
            type="email" 
            class="form-input" 
            id="loginEmail" 
            placeholder="Email (t√™n@7a7.local)"
        >
        <input 
            type="password" 
            class="form-input" 
            id="loginPassword" 
            placeholder="M·∫≠t kh·∫©u"
        >
        
        <button class="login-btn" id="loginSubmit">ƒêƒÉng Nh·∫≠p</button>
        <div class="error-msg" id="loginError"></div>
        
        <p style="margin-top: 20px; font-size: 14px; opacity: 0.6;">
            Ch∆∞a c√≥ t√†i kho·∫£n? <a href="index.html" style="color: #07FAA3;">L√†m b√†i test</a>
        </p>
    </div>
</div>

<!-- Main App -->
<div id="mainApp">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="user-profile">
            <img id="userAvatar" class="avatar" src="" alt="Avatar">
            <div class="user-info">
                <div class="username" id="userName">Loading...</div>
                <div class="coin-display">ü™ô <span id="userCoins">0</span> coins</div>
            </div>
        </div>

        <div class="channels">
            <div class="channel active" data-channel="general">
                üí¨ general-chat
            </div>
            <div class="channel" data-channel="homework">
                üìö h·ªèi-b√†i
            </div>
            <div class="channel" data-channel="announcements">
                üì¢ th√¥ng-b√°o
            </div>
            <div class="channel" data-channel="events">
                üìÖ s·ª±-ki·ªán
            </div>
        </div>

        <!-- Pomodoro Widget -->
        <div class="pomodoro-widget">
            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px;">‚è±Ô∏è POMODORO</div>
            <div class="pomodoro-time" id="pomodoroTime">25:00</div>
            <div class="pomodoro-controls">
                <button class="pomodoro-btn" id="pomodoroStart">Start</button>
                <button class="pomodoro-btn" id="pomodoroReset">Reset</button>
            </div>
            <div class="online-count" id="onlineCount">üë• 0 ƒëang h·ªçc</div>
            <button class="logout-btn" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <div class="channel-name" id="channelName"># general-chat</div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
                Ch∆∞a c√≥ tin nh·∫Øn n√†o
            </div>
        </div>

        <div class="input-container">
            <input 
                type="text" 
                class="message-input" 
                id="messageInput" 
                placeholder="Nh·∫≠p tin nh·∫Øn..."
                maxlength="500"
            >
            <button class="send-btn" id="sendBtn">G·ª≠i</button>
        </div>
    </div>
</div>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyBx6YfJDocmt-WJQvsaKnaUEA_JohxdfC0",
        authDomain: "a7-thcsbk.firebaseapp.com",
        projectId: "a7-thcsbk",
        storageBucket: "a7-thcsbk.firebasestorage.app",
        messagingSenderId: "165000167523",
        appId: "1:165000167523:web:c0d38ab755b699d62e3856"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentChannel = 'general';
    let unsubscribeChat = null;
    let pomodoroInterval = null;
    let pomodoroSeconds = 25 * 60;
    let pomodoroRunning = false;

    // LOGIN LOGIC
    document.getElementById('loginSubmit').onclick = async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorMsg = document.getElementById('loginError');
        const btn = document.getElementById('loginSubmit');

        errorMsg.classList.remove('show');

        if (!email || !password) {
            errorMsg.textContent = 'Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u!';
            errorMsg.classList.add('show');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            let message = 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!';
            if (error.code === 'auth/user-not-found') message = 'Email kh√¥ng t·ªìn t·∫°i!';
            else if (error.code === 'auth/wrong-password') message = 'Sai m·∫≠t kh·∫©u!';
            
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
            btn.disabled = false;
            btn.textContent = 'ƒêƒÉng Nh·∫≠p';
        }
    };

    // AUTH STATE
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            loadUserProfile();
            loadChat();
            startOnlineTracking();
        } else {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.remove('active');
        }
    });

    // LOAD USER PROFILE
    function loadUserProfile() {
        db.collection('users').doc(currentUser.uid).get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('userName').textContent = data.name;
                    document.getElementById('userAvatar').src = data.avatar || '';
                    document.getElementById('userCoins').textContent = data.coins || 0;

                    // Update status to online
                    db.collection('users').doc(currentUser.uid).update({
                        status: 'online',
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });
    }

    // ONLINE TRACKING
    function startOnlineTracking() {
        // Update online users count
        db.collection('users')
            .where('status', '==', 'online')
            .onSnapshot(snapshot => {
                document.getElementById('onlineCount').textContent = `üë• ${snapshot.size} ƒëang h·ªçc`;
            });

        // Keep status updated
        setInterval(() => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }, 60000); // Every minute
    }

    // CHANNEL SWITCHING
    document.querySelectorAll('.channel').forEach(ch => {
        ch.onclick = () => {
            document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
            ch.classList.add('active');
            currentChannel = ch.dataset.channel;
            document.getElementById('channelName').textContent = '# ' + currentChannel;
            loadChat();
        };
    });

    // CHAT LOGIC
    function loadChat() {
        if (unsubscribeChat) unsubscribeChat();

        const container = document.getElementById('messagesContainer');
        container.innerHTML = '<div class="empty-state">ƒêang t·∫£i...</div>';

        unsubscribeChat = db.collection('messages')
            .where('channel', '==', currentChannel)
            .orderBy('timestamp', 'desc')
            .limit(50)
            .onSnapshot(snapshot => {
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ tin nh·∫Øn n√†o</div>';
                    return;
                }

                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                messages.reverse();

                container.innerHTML = messages.map(msg => `
                    <div class="message">
                        <img class="message-avatar" src="${msg.avatar || ''}" alt="">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${sanitize(msg.author)}</span>
                                <span class="message-time">${formatTime(msg.timestamp)}</span>
                                ${msg.userId === currentUser.uid ? 
                                    `<button class="delete-btn" onclick="deleteMessage('${msg.id}')">X√≥a</button>` : 
                                    ''}
                            </div>
                            <div class="message-text">${sanitize(msg.text)}</div>
                        </div>
                    </div>
                `).join('');

                container.scrollTop = container.scrollHeight;
            });
    }

    // SEND MESSAGE
    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('messageInput').onkeypress = (e) => {
        if (e.key === 'Enter') sendMessage();
    };

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text) return;

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;

        try {
            const userData = await db.collection('users').doc(currentUser.uid).get();
            const user = userData.data();

            await db.collection('messages').add({
                channel: currentChannel,
                author: user.name,
                avatar: user.avatar,
                text: text,
                userId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            input.value = '';
        } catch (error) {
            console.error('Send error:', error);
            alert('L·ªói khi g·ª≠i tin nh·∫Øn!');
        } finally {
            btn.disabled = false;
        }
    }

    // DELETE MESSAGE
    function deleteMessage(messageId) {
        if (confirm('X√≥a tin nh·∫Øn n√†y?')) {
            db.collection('messages').doc(messageId).delete()
                .catch(err => alert('L·ªói khi x√≥a!'));
        }
    }

    // POMODORO
    document.getElementById('pomodoroStart').onclick = () => {
        if (pomodoroRunning) {
            // Pause
            clearInterval(pomodoroInterval);
            pomodoroRunning = false;
            document.getElementById('pomodoroStart').textContent = 'Start';
        } else {
            // Start
            pomodoroRunning = true;
            document.getElementById('pomodoroStart').textContent = 'Pause';
            
            pomodoroInterval = setInterval(() => {
                pomodoroSeconds--;
                
                if (pomodoroSeconds <= 0) {
                    clearInterval(pomodoroInterval);
                    pomodoroRunning = false;
                    pomodoroSeconds = 25 * 60;
                    alert('‚è∞ H·∫øt gi·ªù! Ngh·ªâ 5 ph√∫t nh√©!');
                    document.getElementById('pomodoroStart').textContent = 'Start';
                }
                
                updatePomodoroDisplay();
            }, 1000);
        }
    };

    document.getElementById('pomodoroReset').onclick = () => {
        clearInterval(pomodoroInterval);
        pomodoroRunning = false;
        pomodoroSeconds = 25 * 60;
        updatePomodoroDisplay();
        document.getElementById('pomodoroStart').textContent = 'Start';
    };

    function updatePomodoroDisplay() {
        const mins = Math.floor(pomodoroSeconds / 60);
        const secs = pomodoroSeconds % 60;
        document.getElementById('pomodoroTime').textContent = 
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // LOGOUT
    document.getElementById('logoutBtn').onclick = () => {
        if (confirm('ƒêƒÉng xu·∫•t?')) {
            db.collection('users').doc(currentUser.uid).update({
                status: 'offline'
            }).then(() => {
                auth.signOut();
            });
        }
    };

    // UTILITIES
    function sanitize(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate();
        return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    }
</script>
</body>
</html>
