<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªõp 7A7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

```
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Manrope', sans-serif; overflow-x: hidden; background: #050f0a; color: white; }
    .hero-section { position: relative; width: 100%; min-height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; background: linear-gradient(135deg, #050f0a 0%, #0a1e14 50%, #050f0a 100%); }
    .orb-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 1; pointer-events: none; }
    .orb { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.8; animation: float 20s infinite ease-in-out; }
    .orb-1 { width: 800px; height: 550px; background: linear-gradient(225deg, rgba(7, 250, 163, 0.9) 0%, rgba(6, 244, 140, 0.79) 34%, rgba(6, 228, 115, 0.75) 40%, rgba(8, 157, 66, 0.41) 67%, rgba(4, 106, 45, 0) 100%); top: 15%; right: 10%; }
    .orb-2 { width: 800px; height: 550px; background: linear-gradient(45deg, rgba(6, 55, 23, 0) 0%, rgba(4, 106, 15, 0.43) 40%, rgba(1, 183, 62, 0.75) 70%, rgba(0, 208, 88, 0.83) 80%, rgb(2, 220, 100) 100%); filter: blur(40px); top: -5%; left: -5%; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 25% { transform: translate(20px, -20px) scale(1.05); } 50% { transform: translate(-20px, 20px) scale(0.95); } 75% { transform: translate(15px, 15px) scale(1.02); } }
    .content { position: relative; z-index: 10; text-align: center; padding: 60px 40px; max-width: 1200px; animation: fadeInUp 1s ease-out; }
    .main-title { font-size: clamp(48px, 8vw, 90px); font-weight: 800; color: #ffffff; letter-spacing: -0.05em; line-height: 1; margin-bottom: 40px; }
    .subtitle { font-size: clamp(14px, 2vw, 19px); font-weight: 300; color: rgba(255, 255, 255, 0.6); letter-spacing: 0.15em; line-height: 1.4; margin-bottom: 50px; text-transform: uppercase; }
    .cta-button, .submit-answer-btn { display: inline-block; padding: 20px 55px; font-size: 20px; font-weight: 800; color: #ffffff; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 12px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(10px); text-decoration: none; font-family: 'Manrope', sans-serif; position: relative; z-index: 101; }
    .submit-answer-btn { background: linear-gradient(135deg, #07FAA3 0%, #02DC64 100%); color: #050f0a; }
    .submit-answer-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .quiz-container { display: none; position: relative; z-index: 10; text-align: center; padding: 60px 40px; max-width: 1000px; animation: slideIn 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .quiz-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); border-radius: 24px; padding: 50px 40px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); }
    .progress-bar { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; margin-bottom: 30px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #07FAA3 0%, #02DC64 100%); width: 0%; transition: width 0.5s ease; }
    .question-number { display: inline-block; background: #07FAA3; color: #050f0a; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-bottom: 30px; }
    .question-text { font-size: clamp(24px, 4vw, 36px); font-weight: 700; margin-bottom: 50px; }
    .input-container { margin: 40px 0; }
    .name-input { width: 100%; padding: 20px 30px; font-size: 20px; color: #ffffff; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 16px; outline: none; font-family: 'Manrope', sans-serif; }
    .name-input:focus { border-color: #07FAA3; }
    .error-message { color: #ff4444; margin-top: 10px; display: none; font-size: 14px; }
    .error-message.show { display: block; }
    .hint-text { color: rgba(255, 255, 255, 0.4); font-size: 14px; margin-top: 10px; font-style: italic; display: none; }
    .hint-text.show { display: block; }
    .board-container { margin: 20px auto; max-width: 800px; }
    .board-header { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; color: #07FAA3; font-weight: 800; font-size: 18px; }
    .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .seat { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease; font-weight: 700; min-height: 60px; display: flex; align-items: center; justify-content: center; position: relative; z-index: 60; }
    .seat:hover { background: rgba(7, 250, 163, 0.1); border-color: #07FAA3; transform: scale(1.05); }
    .seat.selected { background: rgba(7, 250, 163, 0.2); border-color: #07FAA3; box-shadow: 0 0 20px rgba(7, 250, 163, 0.3); }
    .seat-21 { grid-column: 3; }
    .hidden { display: none !important; }
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #07FAA3; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
    
    .waiting-screen { 
        position: fixed; 
        inset: 0; 
        display: none; 
        align-items: center; 
        justify-content: center; 
        background: #050f0a; 
        color: white; 
        font-family: Manrope; 
        text-align: center; 
        z-index: 9999;
        flex-direction: column;
    }
    .waiting-screen h1 { font-size: clamp(24px, 5vw, 48px); margin-bottom: 20px; }
    .waiting-screen p { opacity: 0.6; margin-top: 10px; font-size: 18px; }

    @media (max-width: 768px) {
        .seat { min-height: 50px; padding: 15px; font-size: 14px; }
        .board { gap: 8px; }
        .quiz-card { padding: 30px 20px; }
        .name-input { font-size: 16px; }
    }
</style>
```

</head>
<body>

```
<section class="hero-section">
    <div class="orb-container">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="content" id="welcomeContent">
        <h1 class="main-title">Ch√†o m·ª´ng ƒë√£ ƒë·∫øn v·ªõi<br>L·ªõp 7A7</h1>
        <p class="subtitle">ƒê·ªÉ b·∫Øt ƒë·∫ßu h√£y tr·∫£ l·ªùi m·ªôt s·ªë c√¢u h·ªèi nh√©</p>
        <button class="cta-button" id="startButton">B·∫Øt ƒê·∫ßu</button>
    </div>

    <div class="quiz-container" id="quizContainer">
        <div class="quiz-card">
            <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            <span class="question-number" id="qNum">C√¢u h·ªèi 1/5</span>
            <h2 class="question-text" id="qText">Nh·∫≠p t√™n c·ªßa b·∫°n</h2>
            <div id="inputArea">
                <div class="input-container">
                    <input type="text" id="answerInput" class="name-input" autocomplete="off">
                    <div class="error-message" id="errorMsg"></div>
                    <div class="hint-text" id="hintText"></div>
                </div>
            </div>
            <div id="boardArea" class="hidden">
                <div class="board-container">
                    <div class="board-header"><div>T·ªï 4</div><div>T·ªï 3</div><div>T·ªï 2</div><div>T·ªï 1</div></div>
                    <div class="board" id="seatingBoard"></div>
                </div>
            </div>
            <button class="submit-answer-btn" id="confirmBtn">X√°c Nh·∫≠n</button>
        </div>
    </div>

    <div class="waiting-screen" id="waitingScreen">
        <div>
            <h1>‚è≥ ƒêang ch·ªù x√°c nh·∫≠n t·ª´ admin</h1>
            <p>B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn trang t·ª± ƒë·ªông khi ƒë∆∞·ª£c duy·ªát</p>
            <div class="loading-spinner" style="margin-top: 30px;"></div>
        </div>
    </div>

    <!-- Profile Setup Screen (after approval) -->
    <div class="quiz-container" id="profileSetup" style="display: none;">
        <div class="quiz-card">
            <h1 style="font-size: 36px; margin-bottom: 10px; background: linear-gradient(135deg, #07FAA3, #02DC64); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üéâ Ch√†o m·ª´ng!</h1>
            <p class="subtitle" style="margin-bottom: 30px;">H√£y t·∫°o t√†i kho·∫£n c·ªßa b·∫°n</p>

            <div style="background: rgba(7,250,163,0.1); border: 1px solid rgba(7,250,163,0.3); padding: 15px; border-radius: 12px; margin-bottom: 30px; font-size: 14px;">
                ‚ÑπÔ∏è Th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng l·ªõp 7A7
            </div>

            <div class="input-container">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #07FAA3; font-size: 14px; text-align: left;">T√™n hi·ªÉn th·ªã</label>
                <input type="text" id="displayName" class="name-input" readonly style="margin-bottom: 20px;">
            </div>

            <div class="input-container">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #07FAA3; font-size: 14px; text-align: left;">·∫¢nh ƒë·∫°i di·ªán</label>
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    <button onclick="document.getElementById('avatarUpload').click()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; cursor: pointer; font-weight: 600; font-family: 'Manrope', sans-serif;">
                        üì∏ Ch·ªçn t·ª´ th∆∞ vi·ªán
                    </button>
                    <button id="autoAssignBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #07FAA3, #02DC64); border: none; border-radius: 10px; color: #050f0a; font-weight: 700; cursor: pointer; font-family: 'Manrope', sans-serif;">
                        üé≤ T·ª± ƒë·ªông ch·ªçn
                    </button>
                </div>
                <div id="avatarPreview" style="text-align: center; margin-bottom: 20px; display: none;">
                    <img id="avatarImg" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid #07FAA3; object-fit: cover;">
                </div>
            </div>

            <div class="input-container">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #07FAA3; font-size: 14px; text-align: left;">M·∫≠t kh·∫©u (ƒë·ªÉ ƒëƒÉng nh·∫≠p)</label>
                <input type="password" id="setupPassword" class="name-input" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" minlength="6" style="margin-bottom: 20px;">
            </div>

            <div class="input-container">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #07FAA3; font-size: 14px; text-align: left;">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
                <input type="password" id="setupConfirmPassword" class="name-input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" style="margin-bottom: 20px;">
            </div>

            <button class="submit-answer-btn" id="createAccountBtn">T·∫°o T√†i Kho·∫£n</button>
            <div class="error-message" id="setupError"></div>
        </div>
    </div>

</section>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBx6YfJDocmt-WJQvsaKnaUEA_JohxdfC0",
        authDomain: "a7-thcsbk.firebaseapp.com",
        projectId: "a7-thcsbk",
        storageBucket: "a7-thcsbk.firebasestorage.app",
        messagingSenderId: "165000167523",
        appId: "1:165000167523:web:c0d38ab755b699d62e3856",
        measurementId: "G-KQDHS4BP3Z"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function normalize(str) {
        return str
            ? str.normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/ƒë/g, "d")
                .toLowerCase()
                .replace(/\s+/g, "")
                .trim()
            : "";
    }

    function sanitizeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function resetUser() {
        if (unsubscribeListener) {
            unsubscribeListener();
            unsubscribeListener = null;
        }

        localStorage.clear();
        studentName = "";
        currentIdx = 0;
        responses = [];
        score = 0;

        // üîß FIX: Don't hide waiting screen immediately, show welcome instead
        const waitingScreen = document.getElementById("waitingScreen");
        const welcomeContent = document.getElementById("welcomeContent");
        const quizContainer = document.getElementById("quizContainer");
        
        waitingScreen.style.display = "none";
        quizContainer.style.display = "none";
        welcomeContent.classList.remove("hidden");
        
        document.getElementById("progressBar").style.width = "0%";
    }

    let unsubscribeListener = null;

    function startVerificationListener() {
        if (unsubscribeListener) {
            unsubscribeListener();
            unsubscribeListener = null;
        }

        const savedName = localStorage.getItem("studentName");
        if (!savedName) return;

        const waitingScreen = document.getElementById("waitingScreen");
        const nameKey = normalize(savedName);

        unsubscribeListener = db.collection("submissions")
            .doc(nameKey)
            .onSnapshot(doc => {
                if (!doc.exists) {
                    console.log("Record deleted ‚Üí reset user");
                    resetUser();
                    return;
                }

                const data = doc.data();

                if (data.verified === true) {
                    if (unsubscribeListener) {
                        unsubscribeListener();
                        unsubscribeListener = null;
                    }
                    // Show profile setup screen
                    document.getElementById("waitingScreen").style.display = "none";
                    document.getElementById("profileSetup").style.display = "block";
                    document.getElementById("displayName").value = studentName;
                    return;
                }

                if (localStorage.getItem("submitted") === "true") {
                    elements.welcome.classList.add("hidden");
                    elements.quiz.style.display = "none";
                    waitingScreen.style.display = "flex";
                }
            }, error => {
                console.error("Listener error:", error);
                elements.error.innerText = "L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.";
                elements.error.classList.add("show");
            });
    }

    const questions = [
        { text: "Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ x√°c nh·∫≠n", type: "name", hint: "T√™n ƒë·∫ßy ƒë·ªß c·ªßa b·∫°n" },
        { text: "Ng√†y, th√°ng, nƒÉm sinh?", type: "input", hint: "vd: 01/01/2013 ho·∫∑c 1/1/2013" },
        { text: "L·ªõp 7A7 c√≥ bao nhi√™u h·ªçc sinh?", type: "input", hint: "S·ªë l∆∞·ª£ng h·ªçc sinh" },
        { text: "C√¥ ch·ªß nhi·ªám l·ªõp 7A7 l√† ai?", type: "input", hint: "T√™n c√¥ gi√°o" },
        { text: "B·∫°n ng·ªìi ch·ªó n√†o?", type: "board", hint: "Ch·ªçn v·ªã tr√≠ c·ªßa b·∫°n" }
    ];

    const classList = [
        "Nguy·ªÖn Ho√†i An","Ph·∫°m B·∫£o An","ƒê·ªó B·∫£o Anh","T·∫° Ho√†ng ƒê·ª©c Anh","ƒê·ªó Phan Gia B·∫£o",
        "Tr∆∞∆°ng Minh B·∫£o","ƒê·ªó C√¥ng B·∫Øc","Ph·∫°m Ng·ªçc B√≠ch","Nguy·ªÖn Th·ªã Qu·ª≥nh Chi",
        "L√Ω Ng·ªçc Di·ªáp","Nguy·ªÖn B√πi H·∫£i ƒêƒÉng","Nguy·ªÖn B·∫Øc ƒê√¨nh ƒê·ªô","H√† Gia H√¢n",
        "Nguy·ªÖn Ng·ªçc H·∫°o","H√† Th·ªã Thu Hu·ªá","Nguy·ªÖn Trung Ph√∫c H∆∞ng","Ph·∫°m Ph√∫c H∆∞ng",
        "Nguy·ªÖn Duy Khang","D∆∞∆°ng M·ªôc K·ª≥","L∆∞∆°ng Di·ªáu Linh","Nguy·ªÖn Di·ªáu Linh",
        "N√¥ng Tr√† My","V≈© Th·ªã Minh Ng·ªçc","ƒê·ªó Tri·ªáu Anh Nguy·ªát","H√† Th·ªã Ng·ªçc Nhi",
        "Tr∆∞∆°ng Y·∫øn Nhi","Nguy·ªÖn Ph√∫c Nh∆∞","Th√¢n T√¢m Nh∆∞","H√† Duy Phong",
        "Nguy·ªÖn ƒêƒÉng Ph√∫","Ph·∫°m Thu Qu·ª≥nh","ƒê·∫∑ng Th√°i S∆°n","T·∫° Thi·ªán T√¢m",
        "N√¥ng Tri·ªáu Minh Th√∫y","ƒê√†m H√† Trang","L√™ Qu√Ω Tr·ªçng","Nguy·ªÖn VƒÉn Tr·ªçng",
        "N√¥ng V√¢n T√πng","Tr·∫ßn Nh∆∞ √ù"
    ];

    const seatMap = {
        "dangthaison": 1, "nguyentrungphuchung": 1, "phamthuquynh": 5, "nguyenduykhang": 5,
        "tathientam": 9, "luongdieulinh": 13, "nguyendieulinh": 13, "haduyphong": 17,
        "nongtramy": 2, "truongminhbao": 2, "nguyenvantrong": 6, "dobaoanh": 6,
        "nguyenthiquynhchi": 10, "hathithuhue": 10, "truongyennhi": 14, "tahoangducanh": 14,
        "lyngocdiep": 18, "lequytrong": 18, "phamngocbich": 3, "hathingocnhi": 3,
        "nguyenbuihaidang": 7, "trannhuy": 7, "nguyendangphu": 11, "nongtrieuminhthuy": 11,
        "dophanthihoaian": 15, "nguyenhoaian": 15, "hagiahan": 19, "nongvantung": 19,
        "nguyenphucnhu": 4, "dophangiabao": 4, "nguyenngochoai": 8, "damhatrang": 8,
        "duongmucky": 12, "docongbac": 16, "vuthiminhngoc": 16, "dotrieuanhnguyet": 20,
        "phambaoan": 21
    };

    let currentIdx = 0;
    let score = 0;
    let studentName = "";
    let responses = [];
    let isSubmitting = false;

    const elements = {
        welcome: document.getElementById("welcomeContent"),
        quiz: document.getElementById("quizContainer"),
        qText: document.getElementById("qText"),
        qNum: document.getElementById("qNum"),
        progressBar: document.getElementById("progressBar"),
        inputArea: document.getElementById("inputArea"),
        boardArea: document.getElementById("boardArea"),
        input: document.getElementById("answerInput"),
        error: document.getElementById("errorMsg"),
        hint: document.getElementById("hintText"),
        confirm: document.getElementById("confirmBtn"),
        board: document.getElementById("seatingBoard")
    };

    function teacherAnswerOk(val) {
        const n = normalize(val);
        return n.includes("co") && n.includes("hong");
    }

    function isValidDateDMY(val) {
        if (!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)) return false;
        const [d, m, y] = val.split("/").map(Number);
        if (y < 2012 || y > 2014) return false;
        if (m < 1 || m > 12) return false;
        const daysInMonth = new Date(y, m, 0).getDate();
        return d >= 1 && d <= daysInMonth;
    }

    document.getElementById("startButton").onclick = () => {
        elements.welcome.classList.add("hidden");
        elements.quiz.style.display = "block";
        loadQuestion();
    };

    function loadQuestion() {
        elements.confirm.disabled = false;
        isSubmitting = false;

        const q = questions[currentIdx];
        elements.qNum.innerText = `C√¢u h·ªèi ${currentIdx+1}/${questions.length}`;
        elements.qText.innerText = q.text;

        if (q.type === "board") {
            elements.inputArea.classList.add("hidden");
            elements.boardArea.classList.remove("hidden");
            renderBoard();
            elements.confirm.disabled = true;
        } else {
            elements.inputArea.classList.remove("hidden");
            elements.boardArea.classList.add("hidden");
            elements.input.value = "";
            elements.error.classList.remove("show");
            elements.hint.classList.remove("show");
            elements.confirm.disabled = false;

            if (q.hint) {
                elements.hint.innerText = q.hint;
                elements.hint.classList.add("show");
            }
        }

        const progress = ((currentIdx + 1) / questions.length) * 100;
        elements.progressBar.style.width = progress + "%";
    }

    function renderBoard() {
        elements.board.innerHTML = "";
        for (let i=1; i<=21; i++) {
            const d = document.createElement("div");
            d.className = "seat";
            d.textContent = i;
            if (i === 21) d.classList.add("seat-21");
            d.onclick = () => {
                document.querySelectorAll(".seat").forEach(s=>s.classList.remove("selected"));
                d.classList.add("selected");
                elements.confirm.disabled = false;
                elements.error.classList.remove("show");
            };
            elements.board.appendChild(d);
        }
    }

    elements.confirm.onclick = () => {
        if (isSubmitting) return;
        
        const q = questions[currentIdx];
        const val = elements.input.value.trim();

        if (currentIdx === 0 && normalize(val) === "admin") {
            window.location.href = "admin.html";
            return;
        }

        if (q.type === "name") {
            if (!val) {
                elements.error.innerText = "Vui l√≤ng nh·∫≠p t√™n!";
                elements.error.classList.add("show");
                return;
            }

            const n = normalize(val);
            const found = classList.some(name => normalize(name)===n);

            if (found) {
                studentName = val;
                responses.push(val);
                score++;
                next();
            } else {
                elements.error.innerText = "T√™n kh√¥ng c√≥ trong danh s√°ch l·ªõp 7A7!";
                elements.error.classList.add("show");
            }
        }

        else if (q.type === "input") {
            if (!val) {
                elements.error.innerText = "Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi!";
                elements.error.classList.add("show");
                return;
            }

            if (currentIdx === 1) {
                if (!isValidDateDMY(val)) {
                    elements.error.innerText = "Ng√†y sinh kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng DD/MM/YYYY";
                    elements.error.classList.add("show");
                    return;
                }
                score++;
            }

            responses.push(val);

            if (currentIdx === 2 && val === "39") score++;
            if (currentIdx === 3 && teacherAnswerOk(val)) score++;

            next();
        }

        else if (q.type === "board") {
            const sel = document.querySelector(".seat.selected");
            if (!sel) {
                elements.error.innerText = "Vui l√≤ng ch·ªçn ch·ªó ng·ªìi!";
                elements.error.classList.add("show");
                return;
            }
            const idx = [...elements.board.children].indexOf(sel)+1;
            responses.push(`Ch·ªó ${idx}`);
            if (seatMap[normalize(studentName)] === idx) score++;
            next();
        }
    };

    function saveSubmission() {
        if (!studentName || responses.length !== 5) return Promise.resolve();

        const nameKey = normalize(studentName);

        return db.collection("submissions")
            .doc(nameKey)
            .set({
                name: sanitizeHTML(studentName),
                nameKey: nameKey,
                answers: responses.map(r => sanitizeHTML(r)),
                score: `${score}/5`,
                verified: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdAtClient: Date.now()
            })
            .then(() => {
                localStorage.setItem("submissionId", nameKey);
                localStorage.setItem("submitted", "true");
            })
            .catch(error => {
                console.error("Save error:", error);
                throw error;
            });
    }

    function finish() {
        if (isSubmitting) return;
        isSubmitting = true;
        
        elements.confirm.disabled = true;
        elements.confirm.innerHTML = '<span class="loading-spinner"></span> ƒêang g·ª≠i...';

        localStorage.setItem("studentName", studentName);
        localStorage.setItem("submitted", "true");
        localStorage.setItem("quizDone", "true");

        saveSubmission()
            .then(() => {
                elements.quiz.style.display = "none";
                elements.progressBar.style.width = "100%";
                document.getElementById("waitingScreen").style.display = "flex";
                startVerificationListener();
            })
            .catch(error => {
                isSubmitting = false;
                elements.confirm.disabled = false;
                elements.confirm.innerHTML = 'X√°c Nh·∫≠n';
                elements.error.innerText = "L·ªói khi g·ª≠i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!";
                elements.error.classList.add("show");
            });
    }

    function next() {
        currentIdx++;
        if (currentIdx < questions.length) loadQuestion();
        else finish();
    }

    let enterKeyTimeout = null;
    document.addEventListener("keydown", e => {
        if (e.key === "Enter" && !elements.confirm.disabled && !isSubmitting) {
            e.preventDefault();
            if (enterKeyTimeout) clearTimeout(enterKeyTimeout);
            enterKeyTimeout = setTimeout(() => {
                if (!elements.confirm.disabled && !isSubmitting) {
                    elements.confirm.click();
                }
            }, 100);
        }
    });

    // üîß FIX: Initialize properly on page load
    document.addEventListener("DOMContentLoaded", () => {
        const savedName = localStorage.getItem("studentName");
        const submitted = localStorage.getItem("submitted") === "true";

        // Always ensure waiting screen is hidden initially
        document.getElementById("waitingScreen").style.display = "none";

        if (savedName && submitted) {
            // User has submitted, check their status
            studentName = savedName;
            elements.welcome.classList.add("hidden");
            elements.quiz.style.display = "none";
            startVerificationListener();
            return;
        }

        // New user - show welcome screen
        elements.welcome.classList.remove("hidden");
        elements.quiz.style.display = "none";
    });

    // PROFILE SETUP LOGIC
    let selectedAvatarFile = null;
    let selectedAvatarUrl = null;

    // Auto-assign 7A7 avatar
    const defaultAvatars = [
        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2307FAA3" width="100" height="100"/><text x="50" y="50" font-size="40" text-anchor="middle" dy=".3em" fill="white" font-family="Arial">7A7</text></svg>',
        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%2302DC64"/><text x="50" y="50" font-size="35" text-anchor="middle" dy=".3em" fill="white" font-family="Arial" font-weight="bold">7A7</text></svg>',
        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23FF6B6B" width="100" height="100"/><text x="50" y="50" font-size="30" text-anchor="middle" dy=".3em" fill="white" font-family="Arial">üéì</text></svg>',
        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%234ECDC4" width="100" height="100"/><text x="50" y="50" font-size="30" text-anchor="middle" dy=".3em" fill="white" font-family="Arial">üìö</text></svg>',
        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23FFE66D" width="100" height="100"/><text x="50" y="50" font-size="30" text-anchor="middle" dy=".3em" fill="white" font-family="Arial">‚ú®</text></svg>'
    ];

    document.getElementById('autoAssignBtn').onclick = () => {
        const randomAvatar = defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)];
        selectedAvatarUrl = randomAvatar;
        selectedAvatarFile = null;
        
        document.getElementById('avatarImg').src = randomAvatar;
        document.getElementById('avatarPreview').style.display = 'block';
    };

    // Upload from gallery
    document.getElementById('avatarUpload').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 5MB');
                return;
            }

            selectedAvatarFile = file;
            selectedAvatarUrl = null;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('avatarImg').src = e.target.result;
                document.getElementById('avatarPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    };

    // Create account
    document.getElementById('createAccountBtn').onclick = async () => {
        const password = document.getElementById('setupPassword').value;
        const confirmPassword = document.getElementById('setupConfirmPassword').value;
        const errorMsg = document.getElementById('setupError');
        const btn = document.getElementById('createAccountBtn');

        errorMsg.classList.remove('show');

        if (!password || password.length < 6) {
            errorMsg.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!';
            errorMsg.classList.add('show');
            return;
        }

        if (password !== confirmPassword) {
            errorMsg.textContent = 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp!';
            errorMsg.classList.add('show');
            return;
        }

        if (!selectedAvatarUrl && !selectedAvatarFile) {
            errorMsg.textContent = 'Vui l√≤ng ch·ªçn ·∫£nh ƒë·∫°i di·ªán!';
            errorMsg.classList.add('show');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> ƒêang t·∫°o t√†i kho·∫£n...';

        try {
            // Create email from student name
            const email = normalize(studentName) + "@7a7.local";

            // Create Firebase Auth account
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            let avatarUrl = selectedAvatarUrl;

            // If user uploaded a file, upload to Firebase Storage
            if (selectedAvatarFile) {
                const storageRef = firebase.storage().ref();
                const avatarRef = storageRef.child(`avatars/${user.uid}`);
                await avatarRef.put(selectedAvatarFile);
                avatarUrl = await avatarRef.getDownloadURL();
            }

            // Create user profile in Firestore
            await db.collection('users').doc(user.uid).set({
                name: studentName,
                email: email,
                avatar: avatarUrl,
                coins: 0,
                status: 'online',
                showOnline: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Clear localStorage
            localStorage.clear();
            
            // Redirect to main
            window.location.href = 'main.html';

        } catch (error) {
            console.error('Setup error:', error);
            
            let message = 'L·ªói khi t·∫°o t√†i kho·∫£n!';
            if (error.code === 'auth/email-already-in-use') {
                message = 'T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i! H√£y ƒëƒÉng nh·∫≠p t·∫°i main.html';
            }
            
            errorMsg.textContent = message;
            errorMsg.classList.add("show");
            btn.disabled = false;
            btn.innerHTML = 'T·∫°o T√†i Kho·∫£n';
        }
    };

</script>
```

</body>
</html>
